---
title: "Domestic citation analysis"
author: "Zuguang Gu ( z.gu@dkfz.de )"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    fig_caption: true
---

```{r, echo = FALSE, message = FALSE}
library(knitr)
knitr::opts_chunk$set(
    error = FALSE,
    tidy  = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.width = 6, fig.height = 6,
    fig.align = "center"
)
```


The number of citations from country A to country B follows a hypergeometric distribution $X \sim \mathrm{hyper}(m, n, N)$
where $m$ is the total number of citations that B is cited, $n$ is the total number of citations that A cites, $N$ is the
total number of citations in the globe. To simplify the problem, we use the binomial approximation of the hypergeometric 
distribution: $X \sim \mathrm{Bi}(p, n)$ where $p = m/N$. The fold enrichment is calculated as


$$
r = \frac{k}{k_\mathrm{exp}} = \frac{k}{np}
$$

where $k$ is the observed number of citations from A to B.

Assume the observed $k$ has a offset to the expected $k_\mathrm{exp}$ of $a \cdot \sigma$ where $\sigma$ is the standard deviation
of the bimonial distribution, then

$$
k = np + a \cdot \sigma = np + a \sqrt{np(1-p)}
$$

And finally we can have the relation between $r$ and $k$ as:

$$
r = \frac{\sqrt{1 + \frac{4k}{a^2(1-p)}} + 1}{\sqrt{1 + \frac{4k}{a^2(1-p)}} - 1}
$$

We can write a function which calculates $\log_2(r)$ based on the value of $k$:

```{r}
f = function(k, a = 1, p = 0.5) {
    r = (sqrt(1 + 4*k/a^2/(1-p)) + 1) /
        (sqrt(1 + 4*k/a^2/(1-p)) - 1)
    log2(r)
}
```

We can demonstrate the relation between $\log_2(r)$ and $k$ by a simple simulation. We generate a list of random $k$
from the binomial distribution where the size $n$ is also randomly generated where $\log_{10}(n)$ is from a uniform
distribution in the internal $[2, 6]$.


```{r}
set.seed(123)
p = 0.1
size = round(10^(runif(10000, min = 3, max = 7)))
k = sapply(size, function(x) rbinom(1, x, p))
```

We plot $\log_2(r)$ verse $k$, also their theoretical relation:

```{r}
plot(k, log2(k/(size*p)), log = "x", pch = 16, cex = 0.5, col = "#00000080")

od = order(k)
lines(k[od], f(k[od], a = 1, p = p), col = 2)
lines(k[od], f(k[od], a = 2, p = p), col = 3)

legend("topright", legend = c("exp + 1*sd", "exp + 2*sd"), lty = 1, col = 2:3)
```

So we can see the log2 fold enrichment decreases when the number of citations increases.

<br>
<br>
<br>
<br>
<br>
<br>
<br>




